{"version":3,"file":"_id_-DkxHxIuJ.js","sources":["../../../../pages/panel/artist/portfolios/[id].vue"],"sourcesContent":["<template>\r\n<div class=\"mt-[20px] w-full flex flex-col items-start justify-start pb-[108px] relative\">\r\n  <div class=\"w-full relative flex flex-row items-center justify-center py-[23px]\">\r\n    <div class=\"font-semibold text-[16px] text-[#141414] leading-[24px]\">نمونه کار</div>\r\n    <BackIcon @click=\"goBack\" class=\"absolute left-[30px]\"/>\r\n  </div>\r\n  <div class=\"w-full flex flex-col my-[21px]\">\r\n    <div class=\"w-full flex flex-col gap-[12px] px-[14px] border-b border-b-[#A9A7A7]\">\r\n      <div class=\"w-full flex flex-row items-start justify-between gap-[12px]\">\r\n        <div class=\"w-full flex-col justify-start items-start\">\r\n          <div class=\"font-medium text-right text-black text-[16px] leading-[21px]\">عنوان</div>\r\n          <input\r\n              v-model=\"form.title\"\r\n              class=\"w-full px-[10px] py-[4px] mx-[10px] mt-[10px] outline-none focus:outline-none text-[16px]\"\r\n              placeholder=\"کراتینه مو,کاشت مژه و...\"\r\n              maxlength=\"40\"\r\n            >\r\n          <span class=\"w-full text-right text-[#828282] text-[14px] font-medium leading-[21px]\">40 / {{ form.title.length }}</span>\r\n        </div>\r\n        <img @click=\"openImageChooser\" :src=\"getThumbnail\" alt=\"\" class=\"w-[80px] h-[80px]\" />\r\n        <input @change=\"onChooseImage\" type=\"file\" hidden multiple accept=\"image/png, images/jpeg\" ref=\"galleryChooser\">\r\n      </div>\r\n      <div class=\"w-full flex flex-row justify-start items-start gap-[12px] mt-[7px] flex-wrap\">\r\n        <div class=\"relative\" v-for=\"(img, i) in prevImages\" :key=\"i\">\r\n          <CloseIcon @click=\"removePrevImage(i)\" class=\"absolute top-[-12px] right-[-12px] z-10\"/>\r\n          <img class=\"w-[80px] h-[80px]\" :src=\"img\" alt=\"\">\r\n        </div>\r\n        <div class=\"relative\" v-for=\"(img, i) in selectedImages\" :key=\"i\">\r\n          <CloseIcon v-if=\"showRemoveImage(i)\" @click=\"removeImage(i)\" class=\"absolute top-[-12px] right-[-12px] z-10\"/>\r\n          <img class=\"w-[80px] h-[80px]\" :src=\"img\" alt=\"\">\r\n          <div v-show=\"uploading[i]\" class=\"w-[80px] h-[80px] flex flex-col justify-center items-center px-[10px] absolute top-0 left-0 right-0 bottom-0 bg-[rgba(0,0,0,.5)]\">\r\n            <div class=\"h-[5px] w-full ltr-dir bg-white rounded-[5px] relative\">\r\n              <div :class=\"`bg-green-300 rounded-[5px] h-[5px] w-[${uploadedFilesPercentages[i]}]`\"></div>\r\n              <div class=\"text-center text-white text-[12px] mt-2\">{{ uploadedFilesPercentages[i] }}</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n      </div>\r\n      <div class=\"w-full flex flex-row items-start justify-between gap-[12px] mt-[7px]\">\r\n        <div class=\"w-full flex-col justify-start items-start\">\r\n          <div class=\"font-medium text-right text-black text-[16px] leading-[21px]\">افزودن توضیحات</div>\r\n          <textarea\r\n              v-model=\"form.description\"\r\n              class=\"w-full px-[10px] py-[4px] mx-[10px] mt-[10px] outline-none focus:outline-none text-[16px]\"\r\n              placeholder=\"کراتینه مو یک روش موثر برای صافی، درخشندگی و شادابی موهای فر ...\"\r\n              maxlength=\"200\"\r\n              rows=\"2\"\r\n          >\r\n          </textarea>\r\n          <span class=\"w-full text-right text-[#828282] text-[14px] font-medium leading-[21px]\">200 / {{ form.description.length }}</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class=\"w-full flex flex-col\">\r\n      <ChooseServiceInput v-model=\"form.service\" />\r\n      <ChooseMaintenanceInput v-model=\"form.maintenance\" />\r\n      <ChooseCallNumberInput\r\n          :has-tel=\"form.has_tel\"\r\n          :has-phone-number=\"form.has_phone_number\"\r\n          :second-phone-number=\"form.second_phone_number\"\r\n          @update:has-tel=\"updateHasTel\"\r\n          @update:has-phone-number=\"updateHasPhoneNumber\"\r\n          @update:second-phone-number=\"updateSecondPhoneNumber\"\r\n      />\r\n      <ChoosePriceInput\r\n          :price=\"form.price\"\r\n          :discount-price=\"form.discount_price\"\r\n          @update:price=\"updatePrice\"\r\n          @update:discount-price=\"updateDiscountPrice\"\r\n      />\r\n    </div>\r\n  </div>\r\n  <button\r\n      @click=\"doSave\"\r\n      :disabled=\"loading\"\r\n      :class=\"[loading ? ' bg-[rgb(177,177,177)]' : ' bg-[#FF3CA0]']\"\r\n      class=\"absolute bottom-[30px] left-[22px] right-[22px] cursor-pointer font-semibold text-center text-[14px] leading-[22px] flex justify-center items-center text-white bg-[#FF3CA0] mt-[10px] rounded-full h-[44px] \">\r\n    <span v-if=\"loading\">\r\n      <LoadingComponent />\r\n    </span>\r\n    <span v-else>\r\n      انتشار\r\n    </span>\r\n  </button>\r\n</div>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\n\r\nimport BackIcon from \"~/components/icons/BackIcon.vue\";\r\nimport CloseIcon from \"~/components/icons/CloseIcon.vue\";\r\nimport ChooseServiceInput from \"~/components/input/ChooseServiceInput.vue\";\r\nimport ChooseMaintenanceInput from \"~/components/input/ChooseMaintenanceInput.vue\";\r\nimport ChoosePriceInput from \"~/components/input/ChoosePriceInput.vue\";\r\nimport ChooseCallNumberInput from \"~/components/input/ChooseCallNumberInput.vue\";\r\nimport {useCustomFetch} from \"~/composables/useCustomFetch\";\r\nimport LoadingComponent from \"~/components/global/Loading.vue\";\r\n\r\ndefinePageMeta({\r\n  layout: 'artist-panel',\r\n  middleware: 'auth'\r\n})\r\n\r\nconst app = useNuxtApp()\r\nconst router = useRouter()\r\nconst route = useRoute()\r\n\r\nconst id = route.params.id\r\nconst {$putRequest: putRequest} = useNuxtApp()\r\nconst loading = ref(false)\r\n\r\nconst galleryChooser = ref()\r\n\r\nconst form = ref({\r\n  title: '',\r\n  description: '',\r\n  maintenance: '',\r\n  service: null,\r\n  price: 0,\r\n  discount_price: 0,\r\n  has_tel: false,\r\n  has_phone_number: false,\r\n  second_phone_number: '',\r\n  images: []\r\n})\r\n\r\nconst prevImages = ref<string[]>([])\r\nconst selectedImages = ref<string[]|ArrayBuffer[]|null[]>([])\r\nconst selectedFiles = ref([])\r\nconst uploadedFilesPercentages = ref([])\r\nconst uploadedFiles = ref([])\r\nconst uploading = ref([])\r\n\r\nconst goBack = () => {\r\n  router.replace('/panel/artist/portfolios')\r\n}\r\n\r\nconst updatePrice = (number: string) => {\r\n  form.value.price = number\r\n}\r\n\r\nconst updateDiscountPrice = (number: string) => {\r\n  form.value.discount_price = number\r\n}\r\n\r\nconst updateSecondPhoneNumber = (number: string) => {\r\n  form.value.second_phone_number = number\r\n}\r\n\r\nconst updateHasPhoneNumber = (has: boolean) => {\r\n  form.value.has_phone_number = has\r\n}\r\n\r\nconst updateHasTel = (has: boolean) => {\r\n  form.value.has_tel = has\r\n}\r\n\r\nconst openImageChooser = () => {\r\n  galleryChooser.value?.click()\r\n}\r\n\r\nconst onChooseImage = async (e) => {\r\n  selectedFiles.value = []\r\n  selectedImages.value = []\r\n  const files = e.target?.files\r\n  if (files.length == 0) {\r\n    return\r\n  }\r\n  for (let i = 0; i < files.length; i++) {\r\n    const reader = new FileReader();\r\n    reader.onload = () => {\r\n      selectedImages.value.push(reader.result)\r\n    };\r\n\r\n    reader.readAsDataURL(files[i]);\r\n  }\r\n  selectedFiles.value = files\r\n  await uploadImages()\r\n}\r\n\r\nconst removeImage = (index) => {\r\n  selectedImages.value.splice(index, 1)\r\n  uploadedFiles.value.splice(index, 1)\r\n}\r\n\r\nconst removePrevImage = (index) => {\r\n  prevImages.value.splice(index, 1)\r\n}\r\n\r\nconst showRemoveImage = (index) => {\r\n  return !uploading.value[index]\r\n}\r\n\r\nconst uploadImages = async () => {\r\n  const l = selectedFiles.value.length\r\n  uploadedFilesPercentages.value = Array(l).fill('0%')\r\n  uploadedFiles.value = Array(l).fill(null)\r\n  uploading.value = Array(l).fill(true)\r\n  for (let i = 0; i < l; i++) {\r\n    await uploadImage(selectedFiles.value[i], i)\r\n  }\r\n}\r\n\r\nconst uploadImage = async (image, index) => {\r\n  const config = useRuntimeConfig()\r\n  const form = new FormData()\r\n  form.append('file', image)\r\n  form.append('type', 'portfolio')\r\n  const xhr = new XMLHttpRequest()\r\n  const xsrf = useCookie('XSRF-TOKEN')\r\n  const token = useCookie('token')\r\n  xhr.open('post', config.public.uploadURL, true)\r\n  xhr.withCredentials = true\r\n  xhr.setRequestHeader('accept', `application/json`)\r\n  xhr.setRequestHeader('X-Xsrf-Token', xsrf.value)\r\n  xhr.setRequestHeader('Authorization', `Bearer ${token.value}`)\r\n  xhr.upload.onprogress = function (ev) {\r\n    const percentComplete = (ev.loaded / ev.total) * 100;\r\n    // uploadPercentage.value.style.width = percentComplete + '%'\r\n    uploadedFilesPercentages.value[index] = percentComplete + '%'\r\n  }\r\n  xhr.onreadystatechange = function () {\r\n    if (xhr.readyState === 4) {\r\n\r\n    }\r\n  }\r\n  xhr.onload = () => {\r\n    if (xhr.status === 200) {\r\n      uploadedFiles.value[index] = JSON.parse(xhr.responseText)\r\n      setTimeout(() => {\r\n        uploading.value[index] = false\r\n      }, 1000)\r\n    } else {\r\n      // uploadState.value = 3\r\n      // console.error('Error:', xhr.statusText);\r\n    }\r\n  };\r\n  xhr.send(form)\r\n}\r\n\r\nconst getThumbnail = computed(() => {\r\n  return form.value.images.length > 0 ? form.value.images[0] : '/panel/choose-image.png'\r\n})\r\n\r\nconst validated = () => {\r\n  let validated = true\r\n  if (!form.value.title) {\r\n    app.$toast.error('لطفا عنوان نمونه کار را وارد کنید', {rtl: true})\r\n    validated = false\r\n  }\r\n  if (!form.value.description) {\r\n    app.$toast.error('لطفا توضیحات نمونه کار را وارد کنید', {rtl: true})\r\n    validated = false\r\n  }\r\n  if (!form.value.service) {\r\n    app.$toast.error('لطفا دسته بندی نمونه کار را انتخاب کنید', {rtl: true})\r\n    validated = false\r\n  }\r\n  if (!form.value.price) {\r\n    app.$toast.error('لطفا قیمت نمونه کار را وارد کنید', {rtl: true})\r\n    validated = false\r\n  }\r\n  if (prevImages.value.length == 0 && selectedImages.value.length == 0) {\r\n    app.$toast.error('لطفا عکس های نمونه کار را انتخاب کنید', {rtl: true})\r\n    validated = false\r\n  }\r\n\r\n  return validated\r\n}\r\n\r\nconst doSave = async () => {\r\n  if (loading.value) return\r\n  if (!validated()) {\r\n    return\r\n  }\r\n  loading.value = true\r\n  const data = {\r\n    title: form.value.title,\r\n    description: form.value.description,\r\n    maintenance: form.value.maintenance,\r\n    service_id: form.value.service?.id,\r\n    price: form.value.price,\r\n    discount_price: form.value.discount_price,\r\n    has_tel: form.value.has_tel,\r\n    has_phone_number: form.value.has_phone_number,\r\n    second_phone_number: form.value.second_phone_number,\r\n    images: [\r\n        ...prevImages.value,\r\n        ...uploadedFiles.value.map(i => i.url)\r\n    ],\r\n  }\r\n  putRequest(`/own/portfolios/${id}`, data)\r\n      .then(async res => {\r\n        app.$toast.success('نمونه کار با موفقیت ویرایش شد')\r\n        await router.push('/panel/artist/portfolios')\r\n      })\r\n      .catch(err => {\r\n        const errors = Object.values(err.data.errors)\r\n        for (const k in errors) {\r\n          for (const e in errors[k]) {\r\n            app.$toast.error(errors[k][e], {rtl: true,})\r\n          }\r\n        }\r\n      })\r\n      .finally(() => {\r\n        loading.value = false\r\n      })\r\n}\r\n\r\nconst getPortfolio = async () => {\r\n  const res = await useCustomFetch(`/own/portfolios/${id}`, {\r\n    method: \"GET\"\r\n  })\r\n  if (res.data.value) {\r\n    const data = res.data.value.data\r\n    form.value.title = data.title\r\n    form.value.description = data.description\r\n    form.value.maintenance = data.maintenance\r\n    form.value.price = data.price\r\n    form.value.discount_price = data.discount_price\r\n    form.value.has_tel = data.has_tel\r\n    form.value.has_phone_number = data.has_phone_number\r\n    form.value.second_phone_number = data.showing_phone_number\r\n    form.value.service = data.service\r\n    prevImages.value = data.images\r\n  }\r\n}\r\n\r\nonMounted(() => {\r\n  nextTick(()=>{\r\n    getPortfolio()\r\n  })\r\n})\r\n</script>\r\n\r\n<style scoped>\r\n\r\n</style>"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAyGA,UAAM,SAAS;AACf,UAAM,QAAQ;AAEH,UAAM,OAAO;AAElB,UAAA,UAAU,IAAI,KAAK;AAEF,QAAI;AAE3B,UAAM,OAAO,IAAI;AAAA,MACf,OAAO;AAAA,MACP,aAAa;AAAA,MACb,aAAa;AAAA,MACb,SAAS;AAAA,MACT,OAAO;AAAA,MACP,gBAAgB;AAAA,MAChB,SAAS;AAAA,MACT,kBAAkB;AAAA,MAClB,qBAAqB;AAAA,MACrB,QAAQ,CAAC;AAAA,IAAA,CACV;AAEK,UAAA,aAAa,IAAc,CAAA,CAAE;AAC7B,UAAA,iBAAiB,IAAmC,CAAA,CAAE;AACtC,QAAI,CAAA,CAAE;AACtB,UAAA,2BAA2B,IAAI,CAAA,CAAE;AACjC,UAAA,gBAAgB,IAAI,CAAA,CAAE;AACtB,UAAA,YAAY,IAAI,CAAA,CAAE;AAExB,UAAM,SAAS,MAAM;AACnB,aAAO,QAAQ,0BAA0B;AAAA,IAAA;AAGrC,UAAA,cAAc,CAAC,WAAmB;AACtC,WAAK,MAAM,QAAQ;AAAA,IAAA;AAGf,UAAA,sBAAsB,CAAC,WAAmB;AAC9C,WAAK,MAAM,iBAAiB;AAAA,IAAA;AAGxB,UAAA,0BAA0B,CAAC,WAAmB;AAClD,WAAK,MAAM,sBAAsB;AAAA,IAAA;AAG7B,UAAA,uBAAuB,CAAC,QAAiB;AAC7C,WAAK,MAAM,mBAAmB;AAAA,IAAA;AAG1B,UAAA,eAAe,CAAC,QAAiB;AACrC,WAAK,MAAM,UAAU;AAAA,IAAA;AA0BjB,UAAA,cAAc,CAAC,UAAU;AACd,qBAAA,MAAM,OAAO,OAAO,CAAC;AACtB,oBAAA,MAAM,OAAO,OAAO,CAAC;AAAA,IAAA;AAG/B,UAAA,kBAAkB,CAAC,UAAU;AACtB,iBAAA,MAAM,OAAO,OAAO,CAAC;AAAA,IAAA;AAG5B,UAAA,kBAAkB,CAAC,UAAU;AAC1B,aAAA,CAAC,UAAU,MAAM,KAAK;AAAA,IAAA;AAkDzB,UAAA,eAAe,SAAS,MAAM;AAC3B,aAAA,KAAK,MAAM,OAAO,SAAS,IAAI,KAAK,MAAM,OAAO,CAAC,IAAI;AAAA,IAAA,CAC9D;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}